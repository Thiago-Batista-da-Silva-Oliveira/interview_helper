# üéØ Integra√ß√£o do Banco de Quest√µes com IA

## üìã Vis√£o Geral

Implementar um sistema inteligente onde a IA recomenda perguntas do banco de quest√µes baseado no curr√≠culo e descri√ß√£o da vaga, mas mant√©m a flexibilidade de criar perguntas customizadas quando necess√°rio.

---

## üèóÔ∏è Arquitetura da Solu√ß√£o

### Fluxo Atual (Antes)
```
StartInterview ‚Üí AI gera perguntas aleatoriamente ‚Üí Entrevista
```

### Fluxo Novo (Depois)
```
StartInterview
  ‚Üí Analisa curr√≠culo + vaga (extrai categorias, n√≠vel, tags)
  ‚Üí Busca perguntas no banco (usando crit√©rios)
  ‚Üí Se encontrou perguntas adequadas:
    ‚Üí Inclui perguntas no prompt da IA
    ‚Üí IA usa essas perguntas como refer√™ncia
    ‚Üí Registra perguntas usadas em InterviewQuestion
  ‚Üí Se n√£o encontrou perguntas adequadas:
    ‚Üí IA cria perguntas customizadas (comportamento atual)
  ‚Üí Entrevista
```

---

## ‚úÖ Checklist de Implementa√ß√£o

### 1Ô∏è‚É£ M√≥dulo QuestionBank
- [ ] Criar `QuestionBankModule` em `src/core/modules/question-bank/`
- [ ] Criar token de inje√ß√£o `QUESTION_BANK_REPOSITORY` em `repositories/tokens.ts`
- [ ] Exportar reposit√≥rio e use cases no m√≥dulo
- [ ] Importar `QuestionBankModule` no `InterviewModule`

### 2Ô∏è‚É£ Use Case: SelectQuestionsService
- [ ] Criar `SelectQuestionsService` em `useCases/SelectQuestions/`
- [ ] Implementar an√°lise inteligente de curr√≠culo e vaga:
  - [ ] Extrair palavras-chave t√©cnicas (React, Node, AWS, etc.)
  - [ ] Identificar n√≠vel da vaga (Junior, Pleno, Senior) via NLP/keywords
  - [ ] Mapear para categorias (FRONTEND, BACKEND, etc.)
  - [ ] Extrair tags relevantes
- [ ] Buscar quest√µes no banco usando `IQuestionSelectionCriteria`
- [ ] Retornar 3-5 perguntas mais relevantes
- [ ] Marcar quest√µes para n√£o repetir na mesma entrevista

**Interface:**
```typescript
interface ISelectQuestionsRequest {
  resumeDescription: string;
  jobDescription: string;
  excludeQuestionIds?: string[];
  maxQuestions?: number; // default: 3-5
}

interface ISelectQuestionsResponse {
  questions: QuestionBank[];
  categories: QuestionCategory[];
  detectedLevel: QuestionLevel;
  matchedTags: string[];
}
```

### 3Ô∏è‚É£ Use Case: RecordInterviewQuestionService
- [ ] Criar `RecordInterviewQuestionService` em `useCases/RecordInterviewQuestion/`
- [ ] Respons√°vel por registrar quest√µes usadas na tabela `InterviewQuestion`
- [ ] Associar `interviewId` com `questionId`
- [ ] Prevenir duplicatas (constraint unique j√° existe no schema)

**Interface:**
```typescript
interface IRecordInterviewQuestionRequest {
  interviewId: string;
  questionIds: string[];
}
```

### 4Ô∏è‚É£ Modificar Prompts
- [ ] Criar novo arquivo `question-aware-prompt.ts`
- [ ] Criar fun√ß√£o `buildInterviewStartPromptWithQuestions()`
  - [ ] Recebe perguntas selecionadas do banco
  - [ ] Formata perguntas no prompt
  - [ ] Instrui IA a usar essas perguntas como base
  - [ ] Permite IA adaptar ou criar perguntas adicionais
- [ ] Manter fallback para `buildInterviewStartPrompt()` se n√£o houver perguntas

**Exemplo de Prompt:**
```typescript
export function buildInterviewStartPromptWithQuestions(
  resumeDescription: string,
  jobDescription: string,
  suggestedQuestions: QuestionBank[],
): string {
  const questionsText = suggestedQuestions
    .map((q, i) => `${i + 1}. ${q.question}`)
    .join('\n');

  return `Voc√™ est√° conduzindo uma entrevista simulada para a seguinte vaga:

DESCRI√á√ÉO DA VAGA:
${jobDescription}

CURR√çCULO DO CANDIDATO:
${resumeDescription}

PERGUNTAS SUGERIDAS DO BANCO (use como refer√™ncia, mas adapte conforme necess√°rio):
${questionsText}

Instru√ß√µes:
1. Comece a entrevista de forma profissional
2. Use as perguntas sugeridas como base, mas sinta-se livre para:
   - Adaptar o contexto √†s respostas do candidato
   - Fazer follow-ups relevantes
   - Criar perguntas adicionais se necess√°rio
3. N√£o precisa fazer TODAS as perguntas listadas
4. Priorize qualidade da conversa sobre seguir a lista rigidamente

Comece agora cumprimentando o candidato e fazendo a primeira pergunta.`;
}
```

### 5Ô∏è‚É£ Refatorar StartInterviewService
- [ ] Injetar `SelectQuestionsService` no construtor
- [ ] Injetar `RecordInterviewQuestionService` no construtor
- [ ] Injetar `IQuestionBankRepository` no construtor
- [ ] Adicionar l√≥gica ap√≥s criar entrevista:
  ```typescript
  // Ap√≥s criar interview e antes de gerar primeira mensagem

  // 1. Selecionar perguntas do banco
  const selectedQuestions = await this.selectQuestionsService.execute({
    resumeDescription,
    jobDescription,
    maxQuestions: 5,
  });

  // 2. Construir prompt apropriado
  let startPrompt: string;

  if (selectedQuestions.questions.length > 0) {
    startPrompt = buildInterviewStartPromptWithQuestions(
      resumeDescription,
      jobDescription,
      selectedQuestions.questions,
    );
  } else {
    // Fallback: comportamento atual
    startPrompt = buildInterviewStartPrompt(
      resumeDescription,
      jobDescription,
    );
  }

  // 3. Gerar primeira mensagem com IA (c√≥digo atual)
  const aiResponse = await this.aiProvider.sendMessage([...]);

  // 4. Registrar perguntas usadas
  if (selectedQuestions.questions.length > 0) {
    await this.recordInterviewQuestionService.execute({
      interviewId: interview.id.toString(),
      questionIds: selectedQuestions.questions.map(q => q.id.toString()),
    });
  }
  ```

### 6Ô∏è‚É£ Reposit√≥rio: InterviewQuestion
- [ ] Criar `IInterviewQuestionRepository` em `interview/repositories/`
- [ ] Criar `PrismaInterviewQuestionRepository` em `infra/database/prisma/repositories/`
- [ ] Implementar m√©todos:
  - `create(interviewId: string, questionId: string): Promise<void>`
  - `findByInterviewId(interviewId: string): Promise<string[]>` (retorna questionIds)
  - `bulkCreate(interviewId: string, questionIds: string[]): Promise<void>`

### 7Ô∏è‚É£ Melhorias nos Prompts de Continua√ß√£o
- [ ] Modificar `SendMessageService` para incluir perguntas usadas no contexto
- [ ] Criar `buildConversationContextWithQuestions()`
- [ ] IA sabe quais perguntas j√° fez (evita repeti√ß√£o)
- [ ] IA pode adaptar follow-ups baseado nas perguntas originais

### 8Ô∏è‚É£ Testes
- [ ] Testes unit√°rios `SelectQuestionsService`:
  - [ ] Detecta n√≠vel corretamente (Junior, Pleno, Senior)
  - [ ] Mapeia categorias (Frontend, Backend, etc.)
  - [ ] Extrai tags relevantes
  - [ ] Retorna perguntas ordenadas por relev√¢ncia
  - [ ] Respeita limite de perguntas
  - [ ] Exclui perguntas j√° usadas
- [ ] Testes unit√°rios `RecordInterviewQuestionService`:
  - [ ] Registra perguntas com sucesso
  - [ ] Previne duplicatas
- [ ] Testes de integra√ß√£o `StartInterviewService`:
  - [ ] Fluxo completo com perguntas do banco
  - [ ] Fluxo fallback sem perguntas no banco
  - [ ] Registra perguntas corretamente

### 9Ô∏è‚É£ Seedar Banco de Dados
- [ ] Executar `npx tsx prisma/seed-questions.ts`
- [ ] Verificar que 60+ perguntas foram inseridas
- [ ] Confirmar categorias e n√≠veis variados

### üîü Documenta√ß√£o
- [ ] Atualizar `PROJECT.md` com nova funcionalidade
- [ ] Adicionar coment√°rios no c√≥digo explicando fluxo
- [ ] Criar exemplos de como adicionar novas perguntas ao banco

---

## üé® L√≥gica de An√°lise Inteligente

### Extra√ß√£o de N√≠vel (QuestionLevel)

```typescript
function detectLevel(jobDescription: string): QuestionLevel {
  const description = jobDescription.toLowerCase();

  // Keywords para cada n√≠vel
  const levelKeywords = {
    JUNIOR: ['junior', 'j√∫nior', 'jr', 'entry-level', 'iniciante', '0-2 anos', 'trainee'],
    PLENO: ['pleno', 'mid-level', 'intermedi√°rio', '2-5 anos', '3-6 anos'],
    SENIOR: ['senior', 's√™nior', 'sr', 'advanced', 'avan√ßado', '5+ anos', 'lead'],
    STAFF: ['staff', 'principal', 'architect', 'arquiteto'],
    PRINCIPAL: ['principal', 'distinguished', 'fellow', 'chief'],
  };

  // Contar matches
  for (const [level, keywords] of Object.entries(levelKeywords)) {
    if (keywords.some(keyword => description.includes(keyword))) {
      return level as QuestionLevel;
    }
  }

  // Default: PLENO (n√≠vel intermedi√°rio)
  return QuestionLevel.PLENO;
}
```

### Extra√ß√£o de Categorias (QuestionCategory)

```typescript
function detectCategories(
  resumeDescription: string,
  jobDescription: string,
): QuestionCategory[] {
  const combined = `${resumeDescription} ${jobDescription}`.toLowerCase();

  const categoryKeywords = {
    FRONTEND: ['react', 'vue', 'angular', 'frontend', 'html', 'css', 'javascript', 'typescript', 'next.js', 'ui', 'ux'],
    BACKEND: ['backend', 'api', 'node', 'express', 'nestjs', 'java', 'spring', 'python', 'django', 'flask', '.net', 'c#', 'golang', 'rust'],
    FULLSTACK: ['fullstack', 'full-stack', 'full stack'],
    MOBILE: ['mobile', 'ios', 'android', 'react native', 'flutter', 'swift', 'kotlin'],
    DEVOPS: ['devops', 'docker', 'kubernetes', 'aws', 'azure', 'gcp', 'terraform', 'ansible', 'jenkins', 'gitlab', 'ci/cd'],
    DATA_SCIENCE: ['data science', 'machine learning', 'ml', 'ai', 'artificial intelligence', 'tensorflow', 'pytorch', 'pandas', 'numpy'],
    SECURITY: ['security', 'seguran√ßa', 'penetration testing', 'owasp', 'cybersecurity'],
    CLOUD: ['cloud', 'aws', 'azure', 'gcp', 'serverless', 'lambda'],
    TESTING: ['testing', 'qa', 'quality assurance', 'test automation', 'selenium', 'cypress', 'jest'],
    PRODUCT_MANAGEMENT: ['product manager', 'pm', 'product owner', 'po', 'agile', 'scrum'],
    DESIGN: ['design', 'ui/ux', 'figma', 'sketch', 'designer'],
    GENERAL: [], // Sempre incluir
  };

  const detectedCategories: QuestionCategory[] = [];

  for (const [category, keywords] of Object.entries(categoryKeywords)) {
    if (keywords.some(keyword => combined.includes(keyword))) {
      detectedCategories.push(category as QuestionCategory);
    }
  }

  // Sempre incluir GENERAL para perguntas comportamentais
  if (!detectedCategories.includes(QuestionCategory.GENERAL)) {
    detectedCategories.push(QuestionCategory.GENERAL);
  }

  return detectedCategories;
}
```

### Extra√ß√£o de Tags

```typescript
function extractTags(
  resumeDescription: string,
  jobDescription: string,
): string[] {
  const combined = `${resumeDescription} ${jobDescription}`.toLowerCase();

  // Lista de tecnologias/skills comuns
  const commonTags = [
    'React', 'Vue', 'Angular', 'Node.js', 'TypeScript', 'JavaScript',
    'Python', 'Java', 'C#', 'Go', 'Rust',
    'AWS', 'Azure', 'GCP', 'Docker', 'Kubernetes',
    'MongoDB', 'PostgreSQL', 'MySQL', 'Redis',
    'REST', 'GraphQL', 'WebSockets',
    'Git', 'CI/CD', 'Agile', 'Scrum',
    'Leadership', 'Communication', 'Problem Solving',
  ];

  return commonTags.filter(tag =>
    combined.includes(tag.toLowerCase())
  );
}
```

---

## üöÄ Ordem de Implementa√ß√£o

### Fase 1: Estrutura Base (30min)
1. Criar QuestionBankModule
2. Criar tokens de inje√ß√£o
3. Criar interfaces de reposit√≥rio InterviewQuestion

### Fase 2: Use Cases (1h)
1. Implementar SelectQuestionsService
2. Implementar RecordInterviewQuestionService
3. Criar testes unit√°rios

### Fase 3: Integra√ß√£o (1h)
1. Refatorar StartInterviewService
2. Criar novos prompts com perguntas
3. Implementar registro de perguntas usadas

### Fase 4: Testes e Ajustes (30min)
1. Testar fluxo completo
2. Ajustar detec√ß√£o de n√≠vel/categoria
3. Validar qualidade das perguntas selecionadas

### Fase 5: Melhorias (30min)
1. Modificar SendMessageService para contexto com perguntas
2. Adicionar logging/debugging
3. Documenta√ß√£o

---

## üìä M√©tricas de Sucesso

- [ ] ‚úÖ 80%+ das entrevistas usam perguntas do banco
- [ ] ‚úÖ Perguntas selecionadas s√£o relevantes para vaga
- [ ] ‚úÖ N√≠vel detectado corresponde √† vaga
- [ ] ‚úÖ IA consegue adaptar perguntas naturalmente
- [ ] ‚úÖ N√£o h√° repeti√ß√£o de perguntas na mesma entrevista
- [ ] ‚úÖ Fallback funciona quando banco n√£o tem perguntas adequadas

---

## üéØ Exemplo de Uso Final

```typescript
// Input
const request = {
  userId: 'user-123',
  resumeDescription: '5 anos de experi√™ncia com React, TypeScript, Node.js. Trabalhei em e-commerce escal√°vel.',
  jobDescription: 'Vaga para Senior Frontend Developer. React, TypeScript, performance optimization.',
  type: InterviewType.TEXT,
};

// Processing
// 1. Detecta: SENIOR, FRONTEND, tags=[React, TypeScript, Performance]
// 2. Busca no banco: 3-5 perguntas relevantes
// 3. Monta prompt com perguntas sugeridas
// 4. IA gera primeira mensagem usando perguntas como refer√™ncia
// 5. Registra perguntas usadas

// Output
{
  interview: Interview,
  firstMessage: Message, // "Ol√°! Vi que voc√™ tem experi√™ncia com React. Como voc√™ otimizaria o re-render de um componente complexo?"
}
```

---

## üîÑ Pr√≥ximos Passos Ap√≥s Implementa√ß√£o

1. **Dashboard de Perguntas**: Interface admin para gerenciar banco de quest√µes
2. **Machine Learning**: Usar ML para melhorar sele√ß√£o de perguntas
3. **Feedback Loop**: Usu√°rios avaliam perguntas ‚Üí melhora sele√ß√£o
4. **Perguntas Din√¢micas**: IA gera e salva novas perguntas boas no banco
5. **Analytics**: Quais perguntas s√£o mais efetivas por categoria/n√≠vel

---

**Pronto para come√ßar? üöÄ**
